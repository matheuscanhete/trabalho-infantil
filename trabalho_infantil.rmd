---
title: "Trabalho Infantil"
subtitle: "An√°lise do Trabalho Infantil"
author: "Matheus Canhete, Felipe Paiva e Karina Reis"
output:
  flexdashboard::flex_dashboard:
    theme: cosmo
    css: style.css
    navbar: 
      - {title: "üè†", href: "https://matheuscanhete.github.io", align: right}
    social: [ "menu" ]
    logo: ./fig/logouf.png
    favicon: ./fig/icon.png 
    orientation: columns
    vertical_layout: fill
---

```{r setup, include = F}
library(flexdashboard)
library(tidyverse)
library(rio)
library(kableExtra)
library(DT)
library(knitr)
library(plotly)
library(RColorBrewer)
library(ggtext)
options(knitr.kable.NA = "--") # troca os NAN do kable
```

# Resultado

Column {data-width=350 .tabset}
------------------------

### Distribui√ß√£o por idade e sexo

```{r tabela1, echo = F}
# V8005 = idade
# V0302 = sexo
# V4746 = situacao ocupacao 5 anos ou mais
# V4742 = rendimento mensal domiciliar per capita
# V4812 = atividade crian√ßas maiores de 5
# V4805 = condi√ß√£o ocupa√ß√£o 10 anos ou mais
# V9001 = trabalhou na semana
# V9058 = numero de horas habitualmente trabalhada
# V4809 = grupos atividade principal 
# V4729 = peso da pessoa
# V4732 = peso da familia

dados <- import("./2015/pes_5_15.Rds") %>% select(V4729, V8005, V0302, V4746, V4812, V4805, V4742,
                                                  V9001, V9058, V4809, nmr_irmaos,
                                                  filhos_domicilio, educacao_pref)
pt1.tabela1 <- dados %>%
  dplyr::filter(V4746 == 1 & V8005 <= 10) %>% # filtrando as crian√ßas ocupadas de 5 a 10
  group_by(V4809, V0302) %>% # atividade desempenhada
  summarise(percental_5_10 = sum(V4729)/sum(.$V4729)*100) %>% 
  ungroup()

pt2.tabela1 <- dados %>%
  dplyr::filter(V4746 == 1 & V8005 >= 11 & V8005 <= 15) %>% # filtrando as crian√ßas ocupadas de 11 a 15
  group_by(V4809, V0302) %>% # atividade desempenhada
  summarise(percental_11_15 = sum(V4729)/sum(.$V4729)*100) %>%
  ungroup()

pt3.tabela1 <- dados %>%
  dplyr::filter(V4746 == 1) %>% # filtrando as crian√ßas ocupadas de 5 a 15
  group_by(V4809, V0302) %>% # atividade desempenhada
  summarise(percental_5_15 = sum(V4729)/sum(.$V4729)*100) %>%
  ungroup()                                                  

tabela1 <- right_join(pt1.tabela1, pt2.tabela1) %>%  # merge das tr√™s partes
  right_join(., pt3.tabela1) %>%
  rename(atividade = V4809, sexo = V0302) 

# troca os valores por strings 
tabela1$sexo <- if_else(tabela1$sexo == 2, "masculino", "feminino")

tabela1$atividade <- factor(tabela1$atividade, levels = c(1,2,3,4,5,6,7,8,9,10,11,12,13),
                            labels = c("Agr√≠cola", "Outras atividades industriais", 
                                       "Ind√∫stria de transforma√ß√£o", "Constru√ß√£o", "Com√©rcio e repara√ß√£o", 
                                       "Alojamento", "Transporte", "Administra√ß√£o p√∫blica", "Servi√ßos sociais",
                                       "Servi√ßos dom√©stico", "Outros servi√ßos coletivos", "Outras atividades", "Atividades maldefinidas"))

tabela1 %>% 
  set_names(c("Atividade","Sexo", "Entre 5 a 10 anos", "Entre 11 a 15 anos", "Entre 5 a 15 anos")) %>% 
  datatable(options = list(pageLength = 20, scrollY = TRUE, dom = "Bfrtip", buttons = c("csv", "pdf")),
            class = "hover",
            rownames = F, 
            extensions = "Buttons") %>% 
  formatRound(columns = c("Entre 5 a 10 anos", "Entre 11 a 15 anos", "Entre 5 a 15 anos"), digits = 2)
```

### Horas trabalhadas

```{r tabela2, echo = F}
pt1.tabela2 <- dados %>%
  dplyr::filter(V4746 == 1 & V8005 <= 10) %>% # filtrando as crian√ßas ocupadas de 5 a 10
  group_by(V4809) %>% # atividade desempenhada
  summarise(horas_trabalhadas_5_10 = weighted.mean(V9058, V4729)) %>%
  ungroup()

pt2.tabela2 <- dados %>%
  dplyr::filter(V4746 == 1 & V8005 >= 11 & V8005 <= 15) %>% # filtrando as crian√ßas ocupadas de 11 a 15
  group_by(V4809) %>% # atividade desempenhada
  summarise(horas_trabalhadas_11_15 = weighted.mean(V9058, V4729)) %>%
  ungroup()

pt3.tabela2 <- dados %>%
  dplyr::filter(V4746 == 1) %>% # filtrando as crian√ßas ocupadas de 5 a 15
  group_by(V4809) %>% # atividade desempenhada
  summarise(horas_trabalhadas_5_15 = weighted.mean(V9058, V4729)) %>%
  ungroup()

tabela2 <- right_join(pt1.tabela2, pt2.tabela2) %>%  # merge das tr√™s partes
  right_join(., pt3.tabela2) %>%
  rename(atividade = V4809) 

# troca os valores por strings 

tabela2$atividade <- factor(tabela2$atividade, levels = c(1,2,3,4,5,6,7,8,9,10,11,12,13),
                            labels = c("Agr√≠cola", "Outras atividades industriais", "Ind√∫stria de transforma√ß√£o", 
                                       "Constru√ß√£o", "Com√©rcio e repara√ß√£o", "Alojamento", "Transporte", "Administra√ß√£o p√∫blica",
                                       "Servi√ßos sociais", "Servi√ßos dom√©stico", "Outros servi√ßos coletivos", 
                                       "Outras atividades","Atividades maldefinidas"))

tabela2 %>% 
  set_names(c("Atividade", "Entre 5 a 10 anos", "Entre 11 a 15 anos", "Entre 5 a 15 anos")) %>% 
  datatable(options = list(pageLength = 20, scrollY = TRUE, dom = "Bfrtip", buttons = c("csv", "pdf")),
            class = "hover",
            rownames = F, 
            extensions = "Buttons") %>% 
  formatRound(columns = c("Entre 5 a 10 anos", "Entre 11 a 15 anos", "Entre 5 a 15 anos"), digits = 2)
```

Column {data-width=350}
-------------

```{r, echo = F, fig.width = 10}
dados$atividade <- factor(dados$V4809, levels = c(1,2,3,4,5,6,7,8,9,10,11,12,13),
                            labels = c("Agr√≠cola", "Outras atividades industriais", 
                                       "Ind√∫stria de transforma√ß√£o", "Constru√ß√£o", "Com√©rcio e repara√ß√£o", 
                                       "Alojamento", "Transporte", "Administra√ß√£o p√∫blica", "Servi√ßos sociais",
                                       "Servi√ßos dom√©stico", "Outros servi√ßos coletivos", "Outras atividades", "Atividades maldefinidas"))

# aumenta n√∫mero de cores da paleta
valores <- colorRampPalette(brewer.pal(11, "Set3"))(13)

dados %>%
  drop_na(.,atividade) %>% 
  select(atividade, V9058, V4729) %>%
  plot_ly(.,
    type = "box",
    x = ~atividade,
    y = ~V9058,
    color = ~atividade,
    colors = valores,
    alpha = 1,
    strokes = "#000000",
    stroke = ~atividade,
    alpha_stroke = .75,
    height = 300
  ) %>% 
  plotly::layout(
    title = list(text = "Horas trabalhadas por atividade"),
    xaxis = list(title = "", showticklabels = F), 
    yaxis = list(title = "Horas habitualmente trabalhadas"),
    autosize = T
  )
```

### 

```{r, echo = F, fig.width = 12}
dados %>% 
  filter(!V4742 > 999999999) %>%
  group_by(filhos_domicilio) %>% 
  summarise(media = weighted.mean(V4742, V4729)) %>%
  plot_ly(.,
    type = "bar",
    x = ~filhos_domicilio,
    y = ~media,
    hoverinfo = "text",
    textposition = "none",
    text = ~paste("filhos:", filhos_domicilio, "<br>rendimento m√©dio:", paste("R$", round(media, 2), "reais"))
  ) %>% 
  layout(
    xaxis = list(title = "filhos no domic√≠lio"),
    yaxis = list(title = "rendimento mensal domiciliar per capita m√©dio"),
    autosize = T
    )
```

# Constru√ß√£o

### Processo para tratamento dos dados da PNAD

<br></br>

Esse projeto foi realizado como parte do crit√©rio para aprova√ß√£o na disciplina "Ci√™ncia de Dados para Economistas" ministrada pelo professor [Roney Fraga](http://roneyfraga.com/) na Faculdade de Economia da UFMT. O objetivo √© aplicar os conhecimentos de `R` adquiridos no curso para limpar e realizar algumas an√°lises em cima de determinada base dados deixando os dados prontos para "uso". No nosso caso utilizamos os microdados da PNAD 2015 e tivemos como base o artigo de [Nascimento e Kassouf (2016)](https://seer.ufrgs.br/AnaliseEconomica/article/view/54855).

Aqui est√£o dispostos os passos para chegar aos [resultados](#resultados), o c√≥digo completo est√° dispon√≠vel [aqui](https://github.com/matheuscanhete/trabalho-infantil). Primeiro importamos o dicion√°rio da PNAD 2015 para leitura em R dispon√≠vel no site do [IBGE](ftp://ftp.ibge.gov.br/Trabalho_e_Rendimento/Pesquisa_Nacional_por_Amostra_de_Domicilios_anual/microdados/2015/).

```{r, eval = F, echo = T}
load("../PNAD/2015/Leitura_em_R_20170517/Leitura em R/dicPNAD2015.Rdata")
```

Os dados dispon√≠veis no site do IBGE tem um problema no dicion√°rio quanto ao in√≠cio das vari√°veis `UF` e `V0102`, ambas iniciam na mesma posi√ß√£o, sendo assim n√£o √© poss√≠vel importar a PNAD diretamente apenas declarando o tamanho das vari√°veis, a alternativa √© eliminar a vari√°vel `UF` do dicion√°rio e carregar a PNAD, assim, as duas vari√°veis ser√£o carregadas como se fossem uma ent√£o √© s√≥ selecionar as duas primeiras posi√ß√µes dessa vari√°vel para obter a vari√°vel `UF`.

```{r, eval = F, echo = T}
dicpes2015 <- dicpes2015[dicpes2015$cod2 != "UF",]
```

```{r, eval = F, echo = T}
# importa a pnad 2015 passando o tamanho das vari√°veis no argumento widths e o nome das colunas em col.names
pnad2015 <- read.fwf("../PNAD/2015/Dados_20170517/Dados/PES2015.txt", 
         widths = dicpes2015$tamanho2,
         col.names = dicpes2015$cod2)

# cria a variavel UF 
pnad2015$uf <- substr(pnad2015$V0102,1,2) 
```

Como o foco do trabalho √© nas pessoas de menos de 15 anos, fazemos esse subset e exportamos os dados em `.rds` para n√£o precisar rodar o c√≥digo acima de novo e tornar a leitura mais r√°pida para o R em um futuro pr√≥ximo. Foi utilizada a fun√ß√£o `export` do pacote [rio](https://www.rdocumentation.org/packages/rio/versions/0.5.16) para exportar o objeto.

```{r, eval = F, echo = T}
pnad2015_15 <- pnad2015[pnad2015$V8005 <= 15,] 

export(pnad2015, "../PNAD/2015/pnad2015.Rds")
```

A partir daqui se d√° a cria√ß√£o das nossas vari√°veis de interesse, escolaridade da pessoa de refer√™ncia e n√∫mero de irm√£os do indiv√≠duo, para obter essa √∫ltima ainda foi necess√°rio criar a vari√°vel que nos da o n√∫mero de filhos no domic√≠lio.

```{r, eval = F, echo = T}
# as nossas vari√°veis de interesse
vars <- c("uf", "V0102", "V0103", "V0301", "V0302", "V8005", "V0401", 
          "V0404", "V4011", "V0701", "V0704", "V7122", "V7128", "V0713",
          "V9001", "V9005", "V9029", "V9532", "V9058", "V9067", "V9971", "V9891", 
          "V9892", "V1272", "V1273", "V4801", "V4805", "V4809", "V4810", "V4812",
          "V4718", "V4728", "V4729", "V4742", "V4746", "V0403", "V6007", "V6003")

pnad2015_merged <- pnad2015 %>%      
  filter(V0401 == 1) %>%              # filtrando apenas as pessoas de referencia  
  group_by(V0102, V0103, V0403) %>%   # agrupando por domicilio (numero de controle, serie e familia)
  summarise(educacao_pref = max(V6007)) %>%   # cria uma variavel com a educa√ß√£o da pessoa de ref
  ungroup() %>%                               # desfaz o agrupamento 
  right_join(.,pnad2015 %>% select(vars))      # fusiona os dois dataframes selecionando apenas as variaveis desejadas da pnad2015
```

Esse processo acima cria o objeto `pnad2015_merged` com a nova vari√°vel `educacao_pref` para cada um dos indiv√≠duos em determinado domic√≠lio.

```{r, eval = F, echo = T}
pnad_broder <- pnad2015_merged %>%      
  subset(V0401 == 3) %>%                # seleciona apenas pessoas que sao filhos
  group_by(V0102, V0103, V0403) %>%     # agrupa por domicilio 
  summarise(filhos_domicilio = n()) %>% # cria uma variavel filhos_domicilio com numero de filhos no domicilio
  ungroup() %>%                         # desagrupa
  right_join(.,pnad2015_merged) %>%     # junta os dois dataframes (o agrupado com variavel filho e o da pnad)
  mutate(., nmr_irmaos =  if_else(V0401 == 3 & filhos_domicilio > 1, filhos_domicilio - 1, 0, missing = NaN)) 
```

Com a fun√ß√£o `mutate` cria-se uma nova vari√°vel `nmr_irmaos` (n√∫mero de irm√£os) utilizando o *statement* if/else vetorizado, onde, se h√° mais de um filho al√©m do indiv√≠duo no domic√≠lio √© subtra√≠do um, e caso n√£o tenha filho al√©m deste recebe 0.

Em tese nossos dados est√£o prontos. Apenas ent√£o "subsetamos" o dataset para pessoas entre 5 e 15 anos e exportamos para an√°lise posterior [aqui](#resultado).

```{r, eval = F, echo = T}
pnad_broder %>% subset(5 <= V8005 & V8005 <= 15) %>% export(., "2015/pes_5_15.Rds")
```

Pequena olhada na tabela dos indiv√≠duos de 5 a 15 anos de idade j√° com as vari√°veis `filhos_domicilio`, `educacao_pref` e `nmr_irmaos`.

```{r tabela, message=F, fig.width=5, fig.cap="Tabelinha"}
import("2015/pes_5_15.Rds") %>% 
  head() %>% 
  kable(., align = "c", "html") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"),
                full_width = F,
                html_font = "Arial") %>% 
  scroll_box(width = "100%")
```
